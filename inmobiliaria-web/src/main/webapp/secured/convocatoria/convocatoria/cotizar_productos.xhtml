<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:fn="http://java.sun.com/jsp/jstl/functions" xmlns:p="http://primefaces.org/ui">
<f:view>
	<h:head>
		<title>#{msg['msg.tituloPrincipal']}</title>
	</h:head>
	<h:body>
		<ui:composition template="/layouts/default.xhtml">
			<ui:define name="content">
				<h:form prependId="false" id="form1">
					<div class="col-sm-12">
						<div class="box">

							<p:messages id="messages" showDetail="true" autoUpdate="false" closable="true" globalOnly="true" for="form1" />

							<div class="box-head">
								<label class="title-head">#{msg['lbl.cotizarConvocatoria']}</label>
							</div>

							<div class="box-body">
								<div class="col-sm-12">

									<p:outputPanel id="pnl1">

										<p:outputPanel id="pnlTitle1" rendered="#{cotizarProductosBean.quotation == null}">
											<div class="col-sm-12">
												<label class="subtitle-head">#{msg['lbl.realizarCotizacion']}</label>
											</div>
										</p:outputPanel>

										<p:outputPanel rendered="#{cotizarProductosBean.userSystem and cotizarProductosBean.quotation == null}" id="pnl2">
											<div class="col-lg-offset-4 col-lg-4 col-md-offset-4 col-md-4 col-sm-12 form-group">
												<label for="slc_provider" class="col-sm-12 control-label">#{msg['lbl.proveedores']}</label>
												<div class="col-sm-12">
													<h:selectOneMenu disabled="#{cotizarProductosBean.quotation != null}" styleClass="form-control" id="slc_provider" value="#{cotizarProductosBean.provider}">
														<f:converter converterId="hdsConvertEntity" />
														<f:selectItem itemLabel="#{msg['lbl.seleccioneItem']}" />
														<f:selectItems value="#{cotizarProductosBean.providers}" var="p" itemLabel="#{p.name}" itemValue="#{p}" />
														<p:ajax event="change" update="tbl" process="@this" listener="#{cotizarProductosBean.loadQuotations()}" />
													</h:selectOneMenu>
												</div>
											</div>

										</p:outputPanel>

										<div class="clearfix" />

										<p:dataTable rendered="#{cotizarProductosBean.quotation == null}" id="tbl" var="item" value="#{cotizarProductosBean.quotations}" paginatorAlwaysVisible="false" paginatorPosition="bottom" rows="5" paginator="true"
											paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" emptyMessage="#{msg['lbl.registrosVacios']}" rowsPerPageTemplate="5,10,15">

											<p:column headerText="#{msg['lbl.convocatoria']}" priority="1">
												<h:outputText value="#{item.convocatory.name}" />
											</p:column>

											<p:column headerText="#{msg['lbl.descripcion']}" priority="5">
												<h:outputText value="#{proinsaludUtilBean.truncate(item.convocatory.description,100, true)}" />
											</p:column>

											<p:column headerText="#{msg['lbl.fechaApertura']}" priority="5" sortBy="#{item.convocatory.opening}" width="200">
												<h:outputText value="#{item.convocatory.opening}">
													<f:convertDateTime locale="es_CO" timeZone="America/Bogota" dateStyle="short" type="date" pattern="dd/MM/yyyy - h:mm:ss a" />
												</h:outputText>
											</p:column>

											<p:column headerText="#{msg['lbl.fechaCierre']}" priority="3" sortBy="#{item.convocatory.expiration}" width="200">
												<h:outputText value="#{item.convocatory.expiration}">
													<f:convertDateTime locale="es_CO" timeZone="America/Bogota" dateStyle="short" type="date" pattern="dd/MM/yyyy - h:mm:ss a" />
												</h:outputText>
											</p:column>

											<p:column headerText="#{msg['lbl.productos']}" priority="5" width="100" styleClass="text-center">
												<h:outputText value="#{item.convocatory.convocatoryProducts.size()}" />
											</p:column>
										
											<p:column priority="1" width="80">
												<p:commandButton action="#{cotizarProductosBean.loadQuotationsProducts()}" process="@this" update="pnl1" title="#{not empty item.quotationConvocatoryProducts ? msg['lbl.editarCotizacion']:msg['lbl.realizarCotizacion']}" styleClass="btn-ic-little" icon="ic-btn-little ic-btn-#{not empty item.quotationConvocatoryProducts ? 'edit':'money'} btn-table" onstart="showSpinner();" onsuccess="hideSpinner();">
													<f:setPropertyActionListener value="#{item}" target="#{cotizarProductosBean.quotation}" />
												</p:commandButton>
											</p:column>

										</p:dataTable>

										<p:outputPanel id="pnlCotizar" rendered="#{cotizarProductosBean.quotation != null}">

											<div class="col-sm-12">
												<label class="subtitle-head">Realizar Cotización</label>
											</div>

											<div class="col-lg-offset-2 col-lg-8 col-md-offset-2 col-md-8 col-sm-12 form-group">
												<div class="col-sm-12">
													<h3 class="text-center">#{cotizarProductosBean.provider.name}</h3>
													<h4 class="text-center">#{cotizarProductosBean.quotation.convocatory.name}</h4>
												</div>

												<div class="clearfix" />

												<div class="col-sm-12">
													<p class="text-justify">#{cotizarProductosBean.quotation.convocatory.description}</p>
												</div>

												<div class="clearfix" />

												<div class="col-sm-6">
													<p:panel style="border:none;">
														<h:panelGrid columns="2" style="width:100%">
															<h:outputText value="Fecha de Apertura:" style="font-weight: bold;" />
															<h:outputText value="#{cotizarProductosBean.quotation.convocatory.opening}">
																<f:convertDateTime locale="es_CO" timeZone="America/Bogota" dateStyle="short" type="date" pattern="dd/MM/yyyy - h:mm:ss a" />
															</h:outputText>

															<h:outputText value="Fecha de Cierre:" style="font-weight: bold;" />
															<h:outputText value="#{cotizarProductosBean.quotation.convocatory.expiration}">
																<f:convertDateTime locale="es_CO" timeZone="America/Bogota" dateStyle="short" type="date" pattern="dd/MM/yyyy - h:mm:ss a" />
															</h:outputText>

														</h:panelGrid>
													</p:panel>
												</div>

											</div>

											<div class="col-lg-offset-2 col-lg-8 col-md-offset-2 col-md-8 col-sm-12">
												<div class="col-sm-12 form-group">
													<p:dataTable id="tblQP" var="item" value="#{cotizarProductosBean.quotationConvocatoryProducts}" editable="#{cotizarProductosBean.editTbl}" editMode="row" widgetVar="cellCars">

														<p:column headerText="Producto">
															<h:outputText value="#{item.convocatoryProduct.product.name}" />
														</p:column>

														<p:column headerText="Cantidad">
															<p:cellEditor>
																<f:facet name="output">
																	<h:outputText value="#{item.quantity}" />
																</f:facet>
																<f:facet name="input">
																	<p:inputText value="#{item.quantity}" style="width:96%" label="Cantidad" required="true" />
																</f:facet>
															</p:cellEditor>
														</p:column>

														<p:column headerText="Valor Unitario">
															<p:cellEditor>
																<f:facet name="output">
																	<h:outputText value="#{item.price}" />
																</f:facet>
																<f:facet name="input">
																	<p:inputText value="#{item.price}" style="width:96%" label="Precio" required="true" />
																</f:facet>
															</p:cellEditor>
														</p:column>

														<p:column style="width:32px" rendered="#{cotizarProductosBean.editTbl}">
															<p:rowEditor editTitle="Editar" saveTitle="Aceptar" cancelTitle="Cancelar" />
														</p:column>

													</p:dataTable>
												</div>

												<div class="clearfix" />

												<div class="col-sm-12 form-group">


													<p:messages styleClass="col-xs-offset-2 col-xs-8" id="messages2" showDetail="true" autoUpdate="false" closable="true" globalOnly="false" for="form1" />

													<div class="clearfix" />

													<div class="col-sm-4">
														<div class="col-sm-12">
															<h:outputLabel for="loadData" value="Descargar Cotización" />
														</div>
														<div class="col-sm-12">
															<p:commandButton onclick="PrimeFaces.monitorDownload(null, onFinishDownload)" title="Descargar Formato de Cotización" ajax="false" process="@this" actionListener="#{cotizarProductosBean.exportarExcel()}" update="@this" styleClass="btn-ic" icon="ic-btn ic-btn-download">
																<p:fileDownload value="#{cotizarProductosBean.download}"></p:fileDownload>
															</p:commandButton>

															<p:commandButton styleClass="btn_download_hide_delete" process="@this" actionListener="#{cotizarProductosBean.onFinishDownload()}" style="display:none" />
														</div>
													</div>

													<div class="col-sm-6">
														<p:outputPanel id="pnlLoadCotizacion" rendered="#{cotizarProductosBean.editTbl}">
															<h:outputLabel for="loadData" value="Cargar Cotización" />
															<h:form id="loadData" prependId="false" enctype="multipart/form-data">
																<p:fileUpload update="pnlCotizar , messages2" label="Elegir archivo" process="@form" fileUploadListener="#{cotizarProductosBean.loadDataExcel}" mode="advanced" allowTypes="/(\.|\/)(xlsx)$/" invalidFileMessage="Error: Tipo de archivo invalido" dragDropSupport="true"
																	uploadLabel="Cargar" cancelLabel="Cancelar">
																</p:fileUpload>
															</h:form>
														</p:outputPanel>
													</div>
												</div>


												<div class="col-sm-12">
													<div class="div-btn">
														<p:commandButton rendered="#{cotizarProductosBean.editTbl}" title="#{msg['lbl.guardar']}" process="@([id$=form1])" action="#{cotizarProductosBean.saveQuotationConvocatory()}" update="pnl1,messages" onstart="showSpinner();" onsuccess="hideSpinner();" styleClass="btn-ic"
															icon="ic-btn ic-btn-save" />
														<p:commandButton title="#{msg['lbl.cancelar']}" process="@this" action="#{cotizarProductosBean.cancel()}" update="pnl1,messages" styleClass="btn-ic" icon="ic-btn ic-btn-cancel" />
													</div>
												</div>
											</div>
										</p:outputPanel>

									</p:outputPanel>
								</div>
							</div>
						</div>
					</div>
				</h:form>
			</ui:define>
		</ui:composition>
	</h:body>
</f:view>
</html>